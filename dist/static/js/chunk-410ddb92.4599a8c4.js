(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-410ddb92"],{"2ca0":function(e,t,a){"use strict";var r=a("23e7"),i=a("06cf").f,l=a("50c4"),o=a("5a34"),s=a("1d80"),c=a("ab13"),n=a("c430"),u="".startsWith,d=Math.min,p=c("startsWith"),b=!n&&!p&&!!function(){var e=i(String.prototype,"startsWith");return e&&!e.writable}();r({target:"String",proto:!0,forced:!b&&!p},{startsWith:function(e){var t=String(s(this));o(e);var a=l(d(arguments.length>1?arguments[1]:void 0,t.length)),r=String(e);return u?u.call(t,r,a):t.slice(a,a+r.length)===r}})},9091:function(e,t,a){},a221:function(e,t,a){"use strict";var r=a("9091"),i=a.n(r);i.a},f41e:function(e,t,a){"use strict";a.r(t);var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("el-form",{attrs:{inline:!0}},[a("el-form-item",{staticStyle:{float:"left"},attrs:{label:"胶料编码"}},[a("el-input",{on:{input:e.productNoChange},model:{value:e.productNo,callback:function(t){e.productNo=t},expression:"productNo"}})],1),a("el-form-item",{staticStyle:{float:"left"},attrs:{label:"胶料名称"}},[a("el-input",{on:{input:e.productNameChange},model:{value:e.productName,callback:function(t){e.productName=t},expression:"productName"}})],1),e.permissionObj.productinfo.indexOf("add")>-1?a("el-form-item",{staticStyle:{float:"right"}},[a("el-button",{on:{click:e.showAddRubberRecipeDialog}},[e._v("新建")])],1):e._e()],1),a("el-table",{staticStyle:{width:"100%"},attrs:{"highlight-current-row":"",data:e.tableData,border:""},on:{"row-click":e.handleCurrentChange}},[a("el-table-column",{attrs:{type:"index",width:"50",label:"No"}}),a("el-table-column",{attrs:{prop:"product_no",label:"胶料编码"}}),a("el-table-column",{attrs:{prop:"product_name",label:"胶料名称"}}),a("el-table-column",{attrs:{prop:"created_username",label:"创建用户"}}),a("el-table-column",{attrs:{prop:"created_date",label:"创建日期"}})],1),a("pagination",{attrs:{total:e.total,"current-page":e.getParams.page},on:{currentChange:e.currentChange}}),a("el-dialog",{attrs:{"close-on-click-modal":!1,"close-on-press-escape":!1,title:"新建胶料代码",visible:e.dialogAddRubberRecipe},on:{"update:visible":function(t){e.dialogAddRubberRecipe=t}}},[a("el-form",{model:{value:e.rubberRecipeForm,callback:function(t){e.rubberRecipeForm=t},expression:"rubberRecipeForm"}},[a("el-form-item",{attrs:{error:e.rubberRecipeFormError.product_no,label:"胶料编码"}},[a("el-input",{model:{value:e.rubberRecipeForm.product_no,callback:function(t){e.$set(e.rubberRecipeForm,"product_no",t)},expression:"rubberRecipeForm.product_no"}})],1),a("el-form-item",{attrs:{error:e.rubberRecipeFormError.product_name,label:"胶料名称"}},[a("el-input",{model:{value:e.rubberRecipeForm.product_name,callback:function(t){e.$set(e.rubberRecipeForm,"product_name",t)},expression:"rubberRecipeForm.product_name"}})],1),a("el-form-item",[a("p",{staticStyle:{color:"red"}},[e._v(e._s(e.rubberRecipeError))])])],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.dialogAddRubberRecipe=!1}}},[e._v("取 消")]),a("el-button",{attrs:{type:"primary"},on:{click:e.handleAddRubberRecipe}},[e._v("生成")])],1)],1),a("el-dialog",{attrs:{"close-on-click-modal":!1,"close-on-press-escape":!1,width:"80%",title:"选择原材料",visible:e.dialogChoiceMaterials},on:{"update:visible":function(t){e.dialogChoiceMaterials=t},open:e.dialogChoiceMaterialsOpen}},[a("el-row",[a("el-form",{attrs:{inline:!0}},[a("el-form-item",{staticStyle:{float:"right"}},[a("el-button",{on:{click:e.rmClicked}},[e._v("RM")])],1),a("el-form-item",{staticStyle:{float:"right"}},[a("el-button",{on:{click:e.selectClicked}},[e._v("选择")])],1)],1)],1),a("el-row",{attrs:{gutter:15}},[a("el-col",{attrs:{span:12}},[a("el-table",{ref:"allMaterialsMultipleTable",staticStyle:{width:"100%"},attrs:{height:"250",border:"",data:e.materials},on:{"selection-change":e.handleMaterialsSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"55"}}),a("el-table-column",{attrs:{label:"原材料代码",prop:"material_no"}}),a("el-table-column",{attrs:{label:"原材料名称",prop:"material_name"}})],1)],1),a("el-col",{attrs:{span:12}},[a("el-table",{ref:"materialsMultipleTable",staticStyle:{width:"100%"},attrs:{border:"",data:e.selectedMaterials},on:{select:e.handleSelect,"selection-change":e.handleSelectedMaterialsSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"55"}}),a("el-table-column",{attrs:{label:"原材料代码",prop:"material_no"}}),a("el-table-column",{attrs:{label:"原材料名称",prop:"material_name"}}),a("el-table-column",{attrs:{label:"车次"},scopedSlots:e._u([{key:"default",fn:function(t){return[t.row.id?a("el-select",{attrs:{placeholder:"请选择"},model:{value:t.row.car_number,callback:function(a){e.$set(t.row,"car_number",a)},expression:"scope.row.car_number"}},e._l(e.carNumberOptionsNotRm,(function(e){return a("el-option",{key:e.id,attrs:{label:e.global_name,value:e.global_name}})})),1):a("el-select",{attrs:{placeholder:"请选择"},model:{value:t.row.car_number,callback:function(a){e.$set(t.row,"car_number",a)},expression:"scope.row.car_number"}},e._l(e.carNumberOptionsRm,(function(e){return a("el-option",{key:e.id,attrs:{label:e.global_name,value:e.global_name}})})),1)]}}])})],1)],1)],1)],1),a("el-dialog",{attrs:{"close-on-click-modal":!1,"close-on-press-escape":!1,title:"胶料配方标准",visible:e.dialogRubberRecipeStandard},on:{"update:visible":function(t){e.dialogRubberRecipeStandard=t}}},[a("el-form",{attrs:{inline:!0}},[a("el-form-item",{staticStyle:{float:"right"}},[1===e.currentRow.used_type||-1===e.currentRow.used_type?a("el-button",{on:{click:e.newClicked}},[e._v("新建 ")]):e._e()],1),a("el-form-item",{staticStyle:{float:"right"}},[1===e.currentRow.used_type||-1===e.currentRow.used_type?a("el-button",{on:{click:e.saveClicked}},[e._v("保存 ")]):e._e()],1)],1),a("table",{staticClass:"table table-bordered",staticStyle:{width:"100%",color:"#909399","font-size":"14px"}},[a("thead",[a("tr",[a("th",[e._v("S")]),a("th",[e._v("No")]),a("th",[e._v("段次")]),a("th",[e._v("类别")]),a("th",[e._v("原材料")]),a("th",[e._v("配比")]),a("th",[e._v("配比累计")])])]),a("tbody",{staticStyle:{color:"#606266"}},[a("tr",{staticStyle:{background:"rgba(189,198,210,0.73)"}},[a("td",{staticStyle:{"text-align":"center"},attrs:{colspan:"5"}},[e._v("配方结果")]),a("td",{staticStyle:{"text-align":"center"}},[e._v(e._s(e.ratioSum))]),a("td")]),e._l(e.selectedMaterials,(function(t,r){return a("tr",{key:r},[a("td"),a("td",[e._v(e._s(r+1))]),a("td",[e._v(e._s(t.car_number))]),a("td",[e._v(e._s(t.material_type_name))]),a("td",[e._v(e._s(t.material_name))]),a("td",{staticStyle:{"text-align":"center"}},[t.car_number&&0!==t.car_number.indexOf("RM")?a("el-input-number",{attrs:{disabled:-1!==e.currentRow.used_type&&1!==e.currentRow.used_type,precision:2,step:.1},on:{change:e.carNumberChanged},model:{value:t.ratio,callback:function(a){e.$set(t,"ratio",e._n(a))},expression:"material.ratio"}}):e._e()],1),a("td",[e._v(e._s(t.ratio_sum))])])}))],2)])],1),a("el-dialog",{attrs:{title:"复制生成新的胶料标准","close-on-click-modal":!1,"close-on-press-escape":!1,visible:e.dialogCopyRubberRecipeStandardVisible},on:{"update:visible":function(t){e.dialogCopyRubberRecipeStandardVisible=t}}},[a("el-form",[a("el-form-item",{attrs:{label:"来源胶料"}},[a("el-col",{attrs:{span:6}},[a("el-input",{attrs:{disabled:""},model:{value:e.sourceFactory,callback:function(t){e.sourceFactory=t},expression:"sourceFactory"}})],1),a("el-col",{staticClass:"line",attrs:{span:2}},[e._v("-")]),a("el-col",{attrs:{span:6}},[a("el-input",{attrs:{disabled:""},model:{value:e.sourceProductNo,callback:function(t){e.sourceProductNo=t},expression:"sourceProductNo"}})],1),a("el-col",{staticClass:"line",attrs:{span:2}},[e._v("-")]),a("el-col",{attrs:{span:6}},[a("el-input",{attrs:{disabled:""},model:{value:e.sourceVersion,callback:function(t){e.sourceVersion=t},expression:"sourceVersion"}})],1)],1),a("el-form-item",{attrs:{label:"新建胶料"}},[a("el-col",{attrs:{span:6}},[a("el-select",{attrs:{placeholder:"请选择"},model:{value:e.newFactory,callback:function(t){e.newFactory=t},expression:"newFactory"}},e._l(e.originOptions,(function(e){return a("el-option",{key:e.id,attrs:{label:e.global_name,value:e.id}})})),1)],1),a("el-col",{staticClass:"line",attrs:{span:2}},[e._v("-")]),a("el-col",{attrs:{span:6}},[a("el-input",{model:{value:e.newProductNo,callback:function(t){e.newProductNo=t},expression:"newProductNo"}})],1),a("el-col",{staticClass:"line",attrs:{span:2}},[e._v("-")]),a("el-col",{attrs:{span:6}},[a("el-input",{model:{value:e.newVersion,callback:function(t){e.newVersion=t},expression:"newVersion"}})],1)],1),a("el-form-item",[a("p",{staticStyle:{color:"red"}},[e._v(e._s(e.copyError))])])],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary"},on:{click:e.handleCopyRubberRecipeStandard}},[e._v("复制")])],1)],1)],1)},i=[],l=(a("4160"),a("c975"),a("a15b"),a("a434"),a("a9e3"),a("b680"),a("ac1f"),a("1276"),a("2ca0"),a("159b"),a("5530")),o=a("3e51"),s=a("1f6c"),c=a("cf45"),n=a("2f62"),u={components:{pagination:o["a"]},data:function(){return{tableData:[],getParams:{page:1},formLabelWidth:c["a"].formLabelWidth,dialogAddRubberRecipe:!1,originOptions:[],rubberRecipeForm:{product_no:"",product_name:""},rubberRecipeFormError:{product_no:"",product_name:""},materials:[],selectedMaterials:[],dialogChoiceMaterials:!1,dialogRubberRecipeStandard:!1,selectingMaterial:!1,toggleMaterials:!1,carNumberOptionsNotRm:[],carNumberOptionsRm:[],ratioSum:0,rubberRecipeError:"",carNumberIdByName:{},currentRow:{used_type:-1},materialById:{},dialogCopyRubberRecipeStandardVisible:!1,sourceFactory:"",sourceProductNo:"",sourceVersion:"",newFactory:"",newProductNo:"",newVersion:"",originByName:{},copyError:"",productNo:"",productName:"",currentPage:1,total:0}},computed:Object(l["a"])({},Object(n["b"])(["permission"])),created:function(){this.permissionObj=this.permission;var e=this;this.getList(),Object(s["n"])("get",{params:{class_name:"产地"}}).then((function(t){e.originOptions=t.results;for(var a=0;a<e.originOptions.length;++a)e.originByName[e.originOptions[a].global_name]=e.originOptions[a]})).catch((function(){})),Object(s["E"])("get",null,{params:{all:1}}).then((function(t){e.materials=t.results;for(var a=0;a<e.materials.length;++a)e.materialById[e.materials[a].id]=e.materials[a]})).catch((function(){})),Object(s["n"])("get",{params:{class_name:"胶料段次"}}).then((function(t){for(var a=0;a<t.results.length;++a)e.carNumberIdByName[t.results[a].global_name]=t.results[a].id,t.results[a].global_name.startsWith("RM")?e.carNumberOptionsRm.push(t.results[a]):e.carNumberOptionsNotRm.push(t.results[a])})).catch((function(){}))},methods:{getList:function(){var e=this;Object(s["N"])("get",null,{params:this.getParams}).then((function(t){e.total=t.count,e.tableData=t.results})).catch((function(){}))},currentChange:function(e){this.getParams.page=e,this.getList()},productNoChange:function(){this.getParams["product_no"]=this.productNo,this.getParams.page=1,this.getList()},productNameChange:function(){this.getParams["product_name"]=this.productName,this.getParams.page=1,this.getList()},usedTypeFormatter:function(e,t){return this.usedTypeChoice(e.used_type)},usedTypeChoice:function(e){switch(e){case 1:return"编辑";case 2:return"通过";case 3:return"应用";case 4:return"驳回";case 5:return"废弃"}},updateFlag:function(e,t){var a=this;Object(s["N"])("patch",e,{data:t}).then((function(e){a.currentChange(a.currentPage)}))},pass:function(e){this.updateFlag(e.id,!0)},reject:function(e){this.updateFlag(e.id,!1)},apply:function(e){this.updateFlag(e.id,!0)},discard:function(e){this.updateFlag(e.id,!1)},showAddRubberRecipeDialog:function(){this.rubberRecipeError="",this.rubberRecipeForm={product_no:"",product_name:""},this.dialogAddRubberRecipe=!0,this.currentRow={used_type:-1}},handleAddRubberRecipe:function(){this.rubberRecipeFormError={product_no:"",product_name:""};var e=this;Object(s["N"])("post",null,{data:{product_no:e.rubberRecipeForm.product_no,product_name:e.rubberRecipeForm.product_name}}).then((function(t){e.$message.success(e.rubberRecipeForm.product_name+"创建成功"),e.getParams.page=1,e.getList(),e.dialogAddRubberRecipe=!1})).catch((function(t){e.rubberRecipeFormError.product_no=t.product_no.join(","),e.rubberRecipeFormError.product_name=t.product_name.join(",")}))},handleMaterialsSelectionChange:function(e){if(!this.toggleMaterials){this.selectingMaterial=!0;for(var t=0;t<e.length;++t)-1===this.selectedMaterials.indexOf(e[t])&&this.selectedMaterials.push(e[t]);for(var a=0;a<this.selectedMaterials.length;++a)this.selectedMaterials[a].id&&-1===e.indexOf(this.selectedMaterials[a])&&(this.selectedMaterials.splice(a,1),--a);var r=this;setTimeout((function(){e&&e.forEach((function(e){r.$refs.materialsMultipleTable.toggleRowSelection(e,!0)})),r.selectingMaterial=!1}),0)}},handleSelectedMaterialsSelectionChange:function(e){if(!this.selectingMaterial&&!this.toggleMaterials){for(var t=0;t<this.materials.length;++t){var a=this.materials[t];-1===e.indexOf(a)&&this.$refs.allMaterialsMultipleTable.toggleRowSelection(a,!1)}if(!e.length)for(var r=0;r<this.selectedMaterials.length;++r)this.selectedMaterials[r].id||(this.selectedMaterials.splice(r,1),--r)}},rmClicked:function(){var e={};this.selectedMaterials.push(e);var t=this;t.$refs.materialsMultipleTable.toggleRowSelection(t.selectedMaterials[t.selectedMaterials.length-1],!0)},handleSelect:function(e,t){t.id||this.selectedMaterials.splice(this.selectedMaterials.indexOf(t),1)},initRatio:function(){for(var e=0;e<this.selectedMaterials.length;++e)0===this.selectedMaterials[e].car_number.indexOf("RM")||this.selectedMaterials[e].ratio||this.$set(this.selectedMaterials[e],"ratio",0),this.selectedMaterials[e].ratio_sum||this.$set(this.selectedMaterials[e],"ratio_sum",0)},selectClicked:function(){if(this.selectedMaterials.length){for(var e=0;e<this.selectedMaterials.length;++e)if(!this.selectedMaterials[e].car_number)return void this.$alert("请选择所有原材料车次","警告",{confirmButtonText:"确定"});this.initRatio(),this.carNumberChanged(),this.dialogChoiceMaterials=!1,this.dialogRubberRecipeStandard=!0}},newClicked:function(){this.dialogRubberRecipeStandard=!1,this.dialogChoiceMaterials=!0},saveClicked:function(){for(var e=0,t=0;t<this.selectedMaterials.length;++t)!this.selectedMaterials[t].material_type_name||"天然胶"!==this.selectedMaterials[t].material_type_name&&"合成胶"!==this.selectedMaterials[t].material_type_name||(e+=this.selectedMaterials[t].ratio);if(100!==e)this.$alert("天然胶加合成胶总配比必须为100","警告",{confirmButtonText:"确定"});else{var a=this,r=[];for(t=0;t<this.selectedMaterials.length;++t){var i={stage:a.carNumberIdByName[a.selectedMaterials[t].car_number],sn:t,ratio:a.selectedMaterials[t].ratio};this.selectedMaterials[t].id&&(i.material=this.selectedMaterials[t].id),r.push(i)}-1!==this.currentRow.used_type?Object(s["N"])("put",this.currentRow.id,{data:{productrecipe_set:r}}).then((function(e){a.dialogRubberRecipeStandard=!1,a.$message(a.currentRow.product_name+"修改成功"),a.currentChange(a.currentPage)})).catch((function(){})):Object(s["N"])("post",null,{data:{product_no:a.rubberRecipeForm.product_no,product_name:a.rubberRecipeForm.product_name,productrecipe_set:r}}).then((function(e){a.dialogRubberRecipeStandard=!1,a.$message(a.rubberRecipeForm.product_name+"创建成功"),a.currentChange(a.currentPage)})).catch((function(){}))}},afterGetData:function(){this.currentRow={used_type:-1}},carNumberChanged:function(){for(var e=0;e<this.selectedMaterials.length;++e)this.selectedMaterials[e-1]?this.selectedMaterials[e].ratio?this.selectedMaterials[e].ratio_sum=this.selectedMaterials[e].ratio+this.selectedMaterials[e-1].ratio_sum:this.selectedMaterials[e].ratio_sum=this.selectedMaterials[e-1].ratio_sum:this.selectedMaterials[e].ratio_sum=this.selectedMaterials[e].ratio,this.selectedMaterials[e].ratio_sum=Number(this.selectedMaterials[e].ratio_sum.toFixed(2));this.ratioSum=this.selectedMaterials[this.selectedMaterials.length-1].ratio_sum},handleCurrentChange:function(e){this.currentRow=e},showRubberRecipeStandardDialog:function(){var e=this;Object(s["N"])("get",this.currentRow.id).then((function(t){e.selectedMaterials=[];for(var a=0;a<t.productrecipe_set.length;++a)if(t.productrecipe_set[a].material){var r=e.materialById[t.productrecipe_set[a].material];r.car_number=t.productrecipe_set[a].stage_name,r.ratio=Number(t.productrecipe_set[a].ratio),e.selectedMaterials.push(r)}else e.selectedMaterials.push({car_number:t.productrecipe_set[a].stage_name});e.selectedMaterials.length&&(e.initRatio(),e.carNumberChanged(),e.dialogRubberRecipeStandard=!0)})).catch((function(){}))},dialogChoiceMaterialsOpen:function(){if(this.selectedMaterials.length){var e=this;this.toggleMaterials=!0,setTimeout((function(){for(var t=0;t<e.selectedMaterials.length;++t){e.$refs.materialsMultipleTable.toggleRowSelection(e.selectedMaterials[t],!0);for(var a=0;a<e.materials.length;++a)if(e.selectedMaterials[t].id&&e.materials[a].id===e.selectedMaterials[t].id){e.$refs.allMaterialsMultipleTable.toggleRowSelection(e.materials[a],!0);break}}e.toggleMaterials=!1}),0)}},copyRecipeClicked:function(){var e=this.currentRow.product_standard_no.split("-");this.sourceFactory=this.currentRow.factory,this.sourceProductNo=e[1],this.sourceVersion=e[2],this.newFactory=this.originByName[this.sourceFactory].id,this.newProductNo=this.sourceProductNo;var t=Number(this.sourceVersion);isNaN(t)?this.newVersion=this.sourceVersion:this.newVersion=t+1,this.dialogCopyRubberRecipeStandardVisible=!0},handleCopyRubberRecipeStandard:function(){this.copyError="";var e=this;Object(s["f"])("post",{data:{product_info_id:e.currentRow.id,factory:e.newFactory,versions:e.newVersion}}).then((function(t){e.dialogCopyRubberRecipeStandardVisible=!1,e.$message(e.currentRow.product_standard_no+"拷贝成功"),e.currentChange(e.currentPage)})).catch((function(t){e.copyError=t.non_field_errors[0]}))}}},d=u,p=(a("a221"),a("2877")),b=Object(p["a"])(d,r,i,!1,null,"12bddde6",null);t["default"]=b.exports}}]);